# kfreestyle2d
Unofficial Kinesis Freestyle 2 Userspace Linux Driver

**SECURITY NOTICE**: This program should not run as root! Read the Install instructions for details on how to set the correct permissions on the device files that the driver opens so that it can do so with normal user permissions.

The Kinesis Freestyle 2 keyboard is a fantastic split keyboard for people
who don't want RSI in their wrists. It has four multimedia keys on
F8-F11 that do not work in Linux. This is a simple program that enables
those keys. If you care how it works, keep reading. If not, skip to the
Build instructions.

## How it works

The multimedia keys seem not to be understood properly by the `hid-generic`
kernel module that usually interprets events from HID (Human Interface Devices).
They are understood by the `hidusb` kernel module though, so you can read the
raw HID file to get the stream of bytes coming from the USB device.

This program uses a special kernel interface called `uinput` that allows drivers
for input devices to run as user programs. kfreestyle2d simply opens the raw byte
stream from the keyboard's special function keys. When it reads a keypress, it
translates the HID Usage ID of the key that it read into a keypress that the
`uinput` system understands. This allows the kernel to interpret the keypress
correctly and dispatch it to userspace programs like Xorg properly.

## Build
`make`

## Install

To give the driver the ability to create a virtual device, you can run the following to grant your user group the ability to read and write the `/dev/uinput` device file. Modify this as appropriate for your machine if you structure your permissions differently:

```bash
echo KERNEL==\"uinput\", GROUP=\"$USER\", MODE:=\"0660\" | sudo tee -a /etc/udev/rules.d/99-$USER.rules
echo KERNEL==\"hidraw\*\", ATTRS\{idVendor\}==\"058f\", ATTRS\{idProduct\}==\"9410\", MODE:=\"0660\", GROUP=\"$USER\" | sudo tee -a /etc/udev/rules.d/99-$USER.rules

sudo udevadm trigger
```

## Run
The driver expects to be given the path to an HID raw input device
that corresponds to the special function keys of a Kinesis Freestyle 2.

To find the correct HID raw input device, unplug your keyboard and
`ls /dev/hidraw*`. Then plug it in and `ls /dev/hidraw*`.

There should be two new `/dev/hidrawX` files the second time.

Try `sudo head -c 1 /dev/hidrawA` where A is the first new raw input file.
Then type on your keyboard. If the command exits, it just read normal keyboard
input from that file, which means that it is **not** the special function key
raw input file. If the command does not exit, try typing one of the special
keys (mute, volumedown, volumeup, calculator). Remember to press the function
key before trying to use these. If the command exits when you type a special
key, this is the file you're looking for.

To start the driver, run:
`./kfreestyle2d /dev/hidrawX` where X is the number of the raw input device
for the special keys.

When the driver is running, it should create a new `/dev/input/eventXX` file,
where XX is some number with 1-3 digits. You can run `sudo evtest /dev/input/eventXX`
on that file to see the output generated by the driver when you press those keys.

If the driver isn't generating output, feel free to create an issue.

If it is, you should now be able to configure your programs to handle these
keys using ordinary X or Wayland key configuration.

## Contribute

Suggestions and PRs welcome!
